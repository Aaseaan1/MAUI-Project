@using JournalApp.Services
@using Microsoft.JSInterop
@implements IDisposable
@rendermode InteractiveServer

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">JournalApp</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="nav flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="home" Match="NavLinkMatch.All">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    <path fill-rule="evenodd" d="M2.5 14a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1V7.707l-5-5-5 5z"/>
                    <path fill-rule="evenodd" d="M13.354 6.354 8 1 2.646 6.354l-.708-.708 5.5-5.5a.5.5 0 0 1 .708 0l5.5 5.5z"/>
                </svg>
                Home
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="create">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a1 1 0 0 1-1 1H4a2 2 0 0 1-2-2z"/>
                    <path fill-rule="evenodd" d="M8 4.5a.5.5 0 0 1 .5.5v2.5H11a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V8.5H5a.5.5 0 0 1 0-1h2.5V5a.5.5 0 0 1 .5-.5"/>
                </svg>
                New Entry
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="search">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                </svg>
                Search
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="filter">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    <path d="M1.5 3a1 1 0 0 1 1-1h11a1 1 0 0 1 .78 1.625L10 8.5v4.793a.5.5 0 0 1-.854.353l-2-2A.5.5 0 0 1 7 11.5V8.5L1.72 3.625A1 1 0 0 1 1.5 3"/>
                </svg>
                Filter
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="calendar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    <path d="M3.5 0a.5.5 0 0 0 0 1H4v1h8V1h.5a.5.5 0 0 0 0-1h-9zM3 3v1h10V3z"/>
                    <path d="M1 4.5A1.5 1.5 0 0 1 2.5 3h11A1.5 1.5 0 0 1 15 4.5V6H1z"/>
                    <path d="M15 7v6.5A1.5 1.5 0 0 1 13.5 15h-11A1.5 1.5 0 0 1 1 13.5V7z"/>
                </svg>
                Calendar
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="analytics">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    <path d="M0 0h1v15h15v1H0z"/>
                    <path d="M6 5a1 1 0 0 1 1-1h1v9H6z"/>
                    <path d="M10 2a1 1 0 0 1 1-1h1v12h-2z"/>
                    <path d="M2 8a1 1 0 0 1 1-1h1v6H2z"/>
                </svg>
                Analytics
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="export">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    <path d="M4 0h5.5L14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2"/>
                    <path d="M9.5 0v4h4"/>
                    <path d="M5 8h4v1H5zm0 2h3v1H5z"/>
                </svg>
                Export PDF
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <button class="nav-link btn btn-link w-100 text-start" @onclick="ToggleTheme">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                    @if (themeService.IsDarkMode)
                    {
                        <path d="M12 8a4 4 0 1 1-8 0 4 4 0 0 1 8 0"/>
                        <path d="M8 0a.5.5 0 0 1 .5.5V2a.5.5 0 0 1-1 0V.5A.5.5 0 0 1 8 0m0 14a.5.5 0 0 1 .5.5V16a.5.5 0 0 1-1 0v-1.5a.5.5 0 0 1 .5-.5m8-6a.5.5 0 0 1-.5.5H14a.5.5 0 0 1 0-1h1.5a.5.5 0 0 1 .5.5M2 .5a.5.5 0 0 1 .5.5v1.5a.5.5 0 0 1-1 0V1a.5.5 0 0 1 .5-.5M2 8a.5.5 0 0 1-.5.5H0a.5.5 0 0 1 0-1h1.5A.5.5 0 0 1 2 8m1.146-6.854a.5.5 0 0 1 .708 0l1.06 1.06a.5.5 0 0 1-.707.708l-1.06-1.061a.5.5 0 0 1 0-.707m0 11.708a.5.5 0 0 1 0-.708l1.06-1.06a.5.5 0 1 1 .707.707l-1.06 1.061a.5.5 0 0 1-.707 0m9.708-11.708a.5.5 0 0 1 0 .708l-1.061 1.06a.5.5 0 1 1-.707-.707l1.06-1.061a.5.5 0 0 1 .708 0m0 11.708a.5.5 0 0 1-.708 0l-1.06-1.06a.5.5 0 0 1 .707-.707l1.061 1.06a.5.5 0 0 1 0 .707"/>
                    }
                    else
                    {
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278"/>
                    }
                </svg>
                @(themeService.IsDarkMode ? "Light" : "Dark") Mode
            </button>
        </div>

        @if (authService.HasPinSet)
        {
            <div class="nav-item px-3">
                @if (authService.IsAuthenticated)
                {
                    <button class="nav-link btn btn-link w-100 text-start" @onclick="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10.146 12.354a.5.5 0 0 1 0-.708L12.793 9H5.5a.5.5 0 0 1 0-1h7.293l-2.647-2.646a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708 0"/>
                            <path fill-rule="evenodd" d="M13 15.5a.5.5 0 0 0 .5-.5v-3.25a.5.5 0 0 1 1 0V15A1.5 1.5 0 0 1 13 16.5H3A1.5 1.5 0 0 1 1.5 15V1A1.5 1.5 0 0 1 3 .5h10A1.5 1.5 0 0 1 14.5 2v3.25a.5.5 0 0 1-1 0V2a.5.5 0 0 0-.5-.5H3a.5.5 0 0 0-.5.5v14a.5.5 0 0 0 .5.5z"/>
                        </svg>
                        Log out
                    </button>
                }
                else
                {
                    <NavLink class="nav-link" href="login" Match="NavLinkMatch.All">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" class="me-2" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10.146 12.354a.5.5 0 0 1 0-.708L12.793 9H5.5a.5.5 0 0 1 0-1h7.293l-2.647-2.646a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708 0"/>
                            <path fill-rule="evenodd" d="M3 2.5A1.5 1.5 0 0 1 4.5 1h4A1.5 1.5 0 0 1 10 2.5V6a.5.5 0 0 1-1 0V2.5a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5V10a.5.5 0 0 1 1 0v3.5A1.5 1.5 0 0 1 8.5 15h-4A1.5 1.5 0 0 1 3 13.5z"/>
                        </svg>
                        Login
                    </NavLink>
                }
            </div>
        }
    </nav>
</div>

@code {
    [Inject]
    private ThemeService themeService { get; set; } = default!;

    [Inject]
    private AuthService authService { get; set; } = default!;

    [Inject]
    private NavigationManager navigationManager { get; set; } = default!;

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private async Task ToggleTheme()
    {
        themeService.ToggleTheme();
        await JS.InvokeVoidAsync("toggleThemeClass", themeService.IsDarkMode);
    }

    private void Logout()
    {
        authService.Logout();
        navigationManager.NavigateTo("/login", forceLoad: true);
    }

    protected override void OnInitialized()
    {
        themeService.OnThemeChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("toggleThemeClass", themeService.IsDarkMode);
        }
    }

    public void Dispose()
    {
        themeService.OnThemeChanged -= StateHasChanged;
    }
}
